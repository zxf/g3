/*!
* g3 v0.0.1
* Copyright 2013 Felix.Zhu
*/
var g3=function(){var a={};MODULESPARATOR=".";var b={};a.module=function(){if(1==arguments.length){if("string"==typeof arguments[0]){var c=[];arguments[0]&&(c=arguments[0].split(MODULESPARATOR));for(var d=b,e=0;e<c.length;e++){if(!(c[e]in d)){d=void 0;break}d=d[c[e]]}return d}for(var f in arguments[0]){var g=f.split(MODULESPARATOR),h=g.pop(),i=a.module(g.join(MODULESPARATOR));i[h]=arguments[0][f]}return b}if("string"==typeof arguments[0]){var d=a.module(arguments[0]);if(void 0!==d)for(var f in arguments[1])d[f]=arguments[1][f];else{var j={};j[arguments[0]]=arguments[1],a.module(j),d=arguments[1]}return d}return void 0},a.Object=function(){},a.Object.prototype={init:function(){}},a.extendClass=function(){var b=a.Object,c={};"string"==typeof arguments[0]?(b=a.module(arguments[0]),c=arguments[1]):"function"==typeof arguments[0]?(b=arguments[0],c=arguments[1]):c=arguments[0];var d=function(){this.parent=e.prototype,this.init.apply(this,arguments)},e=function(){};e.prototype=b.prototype,d.prototype=new e;for(var f in c)d.prototype[f]=c[f];return d};var c={};return a.exports=function(a){for(var b in a)c[b]=a[b]},function(){var b={each:function(a,b){for(var c in a)if(b(a[c],c)===!1)break},map:function(a,b){var c;c=a instanceof Array?[]:{};for(var d in a)c[d]=b(a[d],d);return c},extend:function(){var a=!1,c=0;arguments[0]===!0&&(a=!0,c=1);for(var d=function(c){if(a){if(c instanceof Array)return b.extend(!0,[],c);if(c instanceof Object)return b.extend(!0,{},c)}return c},e=arguments[c],f=c+1;f<arguments.length;f++)if(arguments[f]instanceof Array)for(var g=0;g<arguments[f].length;g++)e[g]=d(arguments[f][g]);else for(var h in arguments[f])e[h]=d(arguments[f][h]);return e},toArray:function(a){return Array.prototype.slice.call(a)},degToRad:function(a){var b=Math.PI/180;return a*b}};a.module("utils",b)}(),function(){var b=a.module("utils"),c=a.extendClass({init:function(){this._events={}},_bind:function(a,b){a in this._events||(this._events[a]=[]),this._events[a].push(b)},bind:function(){if("string"==typeof arguments[0])this._bind(arguments[0],arguments[1]);else for(var a in arguments[0]){var b=arguments[0][a];this._bind(a,b)}},unbind:function(a,b){if(void 0==b)this._events[a]=null,delete this._events[a];else{var c=(this._events[a]||[]).indexOf(b);c>=0&&this._events[a].splice(c,1)}},trigger:function(){var a=b.toArray(arguments),c=a.shift(),d=this._events[c]||[];for(var e in d)if(d[e].apply(this,a)===!1)return!1;return null},clear:function(){this._events={}}});a.module("event",{master:c})}(),function(){var b=a.extendClass({init:function(){}});a.module("backends",{base:b})}(),function(){var b=a.module("utils"),c=a.extendClass("backends.base",{init:function(a,b){if(!window.THREE)throw"require three.js.";this.camera=new THREE.PerspectiveCamera(75,a/b,1,1100),this.scene=new THREE.Scene,this.renderer=new THREE.CanvasRenderer,this.renderer.setSize(a,b),this.texture_placeholder=document.createElement("canvas"),this.texture_placeholder.width=128,this.texture_placeholder.height=128},addCubeScene:function(a){var c=this;a=b.map(a,function(a){return c.loadTexture(a)});var d=new THREE.Mesh(new THREE.CubeGeometry(300,300,300,7,7,7),new THREE.MeshFaceMaterial(a)),e=new THREE.MeshFaceMaterial(a),f=new THREE.Sprite(e);f.scale.y=1,f.scale.x=1,f.position.x=1,f.position.z=1,d.scale.x=-1,this.scene.add(d),this.scene.add(f)},loadTexture:function(a){var b=this,c=new THREE.Texture(this.texture_placeholder),d=new THREE.MeshBasicMaterial({map:c,overdraw:!0}),e=new Image;return e.onload=function(){c.needsUpdate=!0,d.map.image=this,b.render()},e.src=a,d},lookAt:function(a){a=new THREE.Vector3(a.x,a.y,a.z),this.camera.lookAt(a)},render:function(){this.renderer.render(this.scene,this.camera)},dom:function(){return this.renderer.domElement}});a.module("backends",{three:c})}(),function(){var b=a.extendClass({init:function(){}});a.module("panorama",{hotspot:b})}(),function(){a.module("panorama.hotspot");var b=a.extendClass({}),c=a.extendClass(b,{}),d=a.extendClass(b,{init:function(a){this.materials=a,this.lon=0,this.lat=0},setPos:function(a,b){this.lon=a,this.lat=b},getLon:function(){return this.lon},getLat:function(){return this.lat},addHotspot:function(){}});a.module("panorama",{scene:{"static":c,panorama:d}})}(),function(){var b=a.module("utils"),c=a.module("backends.three"),d=(a.module("event.master"),a.module("panorama.scene.static"),a.module("panorama.scene.panorama")),e=a.extendClass({init:function(a,b,d){this.container=a,this.backend=new c(b,d),this.scene=null,this._draggable=!0,this.bindEvents()},bindEvents:function(){var a=this,b=!1,c=0,d=0,e=0,f=0,g=function(e){a.isDraggable()&&(e.preventDefault(),b=!0,onPointerDownPointerX=e.clientX,onPointerDownPointerY=e.clientY,c=a.scene.getLon(),d=a.scene.getLat())},h=function(g){a.isDraggable()&&b&&(e=.1*(onPointerDownPointerX-g.clientX)+c,f=.1*(g.clientY-onPointerDownPointerY)+d,a.moveTo(e,f))},i=function(){a.isDraggable()&&(b=!1,a.moveTo(e,f))},j=function(b){a.isDraggable()&&1==b.touches.length&&(b.preventDefault(),onPointerDownPointerX=b.touches[0].pageX,onPointerDownPointerY=b.touches[0].pageY,c=e,d=f)},k=function(b){a.isDraggable()&&1==b.touches.length&&(b.preventDefault(),e=.1*(onPointerDownPointerX-b.touches[0].pageX)+c,f=.1*(b.touches[0].pageY-onPointerDownPointerY)+d,a.moveTo(e,f))};this.container.addEventListener("mousedown",g,!1),this.container.addEventListener("mousemove",h,!1),this.container.addEventListener("mouseup",i,!1),this.container.addEventListener("touchstart",j,!1),this.container.addEventListener("touchmove",k,!1)},dom:function(){return this.backend.dom()},posToCoord:function(a,c){c=Math.max(-85,Math.min(85,c));var d=b.degToRad(90-c),e=b.degToRad(a),f=500*Math.sin(d)*Math.cos(e),g=500*Math.cos(d),h=500*Math.sin(d)*Math.sin(e);return{x:f,y:g,z:h}},draggable:function(a){this._draggable=a},isDraggable:function(){return this._draggable&&this.scene},moveTo:function(a,b){this.backend.lookAt(this.posToCoord(a,b)),this.scene.setPos(a,b),this.backend.render()},render:function(a){this.backend.addCubeScene(a.materials),this.backend.lookAt(this.posToCoord(a.getLon(),a.getLat())),this.backend.render(),this.scene=a}}),f=a.extendClass({init:function(a){this.opts=b.extend({},a),this.container=this.getOption("container"),this.renderer=new e(this.container,this.getOption("width"),this.getOption("height")),this.draggable(this.getOption("draggable")),this.scenes={},this._scene=null,this.bindEvents()},getOption:function(a,b){return a in this.opts?this.opts[a]:b},draggable:function(a){this.renderer.draggable(a),this.opts.draggable=a},bindEvents:function(){this.container.appendChild(this.dom())},addScene:function(a,b){var c=new d(b);this.scenes[a]=c,this._default||(this._default=a)},switchScene:function(a){this._active=a,this.renderer.render(this.scenes[a])},setDefaultScene:function(a){this._default=a},render:function(){var a=this._active||this._default;this.switchScene(a)},dom:function(){return this.renderer.dom()}});a.module("panorama",{render:e,panorama:f})}(),function(){var b=a.module("panorama.panorama");a.exports({Panorama:b})}(),c}();