/*!
* g3 v0.0.1
* Copyright 2014 Felix.Zhu
*/
var g3=function(){var a={},b=".",c={};a.module=function(){if(1==arguments.length){if("string"==typeof arguments[0]){var d=[];arguments[0]&&(d=arguments[0].split(b));for(var e=c,f=0;f<d.length;f++){if(!(d[f]in e)){e=void 0;break}e=e[d[f]]}return e}for(var g in arguments[0]){var h=g.split(b),i=h.pop(),j=a.module(h.join(b));j[i]=arguments[0][g]}return c}if("string"==typeof arguments[0]){var e=a.module(arguments[0]);if(void 0!==e)for(var g in arguments[1])e[g]=arguments[1][g];else{var k={};k[arguments[0]]=arguments[1],a.module(k),e=arguments[1]}return e}return void 0},a.Object=function(){},a.Object.prototype={init:function(){}},a.extendClass=function(){var b=a.Object,c={};"string"==typeof arguments[0]?(b=a.module(arguments[0]),c=arguments[1]):"function"==typeof arguments[0]?(b=arguments[0],c=arguments[1]):c=arguments[0];var d=function(){this.parent=e.prototype,this.super=function(a,b){return this.parent[a].apply(this,b)},this.init.apply(this,arguments)},e=function(){};e.prototype=b.prototype,d.prototype=new e;for(var f in c)d.prototype[f]=c[f];return d};var d={};return a.exports=function(a){for(var b in a)d[b]=a[b]},function(){var b={};b={each:function(a,b){for(var c in a)if(b(a[c],c)===!1)break},map:function(a,b){var c;c=a instanceof Array?[]:{};for(var d in a)c[d]=b(a[d],d);return c},extend:function(){var a=!1,c=0;arguments[0]===!0&&(a=!0,c=1);for(var d=function(c){if(a){if(c instanceof Array)return b.extend(!0,[],c);if(c instanceof Object)return b.extend(!0,{},c)}return c},e=arguments[c],f=c+1;f<arguments.length;f++)if(arguments[f]instanceof Array)for(var g=0;g<arguments[f].length;g++)e[g]=d(arguments[f][g]);else for(var h in arguments[f])e[h]=d(arguments[f][h]);return e},toArray:function(a){return Array.prototype.slice.call(a)},degToRad:function(a){var b=Math.PI/180;return a*b},proxy:function(a,b){return function(){return a.apply(b,arguments)}}},b.WidgetObject=a.extendClass({default_options:{},init:function(a){this.opts=b.extend({},this.default_options,a)},option:function(){return 1==arguments.length?"string"==typeof arguments[0]?this.getOption(arguments[0]):(b.extend(this.opts,arguments[0]),!0):(this.setOption(arguments[0],arguments[1]),!0)},getOption:function(a,b){return a in this.opts?this.opts[a]:b},setOption:function(a,b){this.opts[a]=b}}),a.module("utils",b)}(),function(){var b=a.module("utils"),c=a.extendClass({init:function(a){this._scope=a||window,this._events={}},_bind:function(a,b){a in this._events||(this._events[a]=[]),this._events[a].push(b)},bind:function(){if("string"==typeof arguments[0])this._bind(arguments[0],arguments[1]);else for(var a in arguments[0]){var b=arguments[0][a];this._bind(a,b)}},unbind:function(a,b){if(void 0==b)this._events[a]=null,delete this._events[a];else{var c=(this._events[a]||[]).indexOf(b);c>=0&&this._events[a].splice(c,1)}},trigger:function(){var a=b.toArray(arguments),c=a.shift(),d=this._events[c]||[];for(var e in d)if(d[e].apply(this._scope,a)===!1)return!1;return null},clear:function(){this._events={}}});G3Event=a.extendClass({init:function(a){this._data=a}}),a.module("event",{Master:c,Event:G3Event})}(),function(){var b=a.extendClass({init:function(){}});a.module("backends",{Base:b})}(),function(){var b=a.module("utils"),c=a.extendClass("backends.Base",{init:function(a,b){if(!window.THREE)throw"require three.js.";this.camera=new THREE.PerspectiveCamera(75,a/b,1,1e3),this.scene=new THREE.Scene,this.group=null,this.renderer=new THREE.CanvasRenderer,this.renderer.setSize(a,b),this.texture_placeholder=document.createElement("canvas"),this.texture_placeholder.width=128,this.texture_placeholder.height=128},setScene:function(a){var c=this;this.clear(),this.group=new THREE.Object3D,this.scene.add(this.group),materials=b.map(a.materials,function(a){return c.loadTexture(a)});var d=new THREE.Mesh(new THREE.SphereGeometry(300,300,300,7,7,7),new THREE.MeshFaceMaterial(materials));d.scale.x=-1,this.setHotspots(a.hotspots)},setHotspots:function(a){for(var b in a){a[b];var c=new THREE.Mesh(new THREE.CubeGeometry(100,100,100),new THREE.MeshBasicMaterial({color:16777215*Math.random(),opacity:.5}));this.group.add(c)}},loadTexture:function(a){var b=this,c=new THREE.Texture(this.texture_placeholder),d=new THREE.MeshBasicMaterial({map:c,overdraw:!0}),e=new Image;return e.onload=function(){c.needsUpdate=!0,d.map.image=this,b.render()},e.src=a,d},lookAt:function(a){a=new THREE.Vector3(a.x,a.y,a.z),this.camera.lookAt(a),this.render()},setZoom:function(a){this.camera.fov=75-6*a,this.camera.updateProjectionMatrix(),this.render()},setSize:function(a,b){this.camera.aspect=a/b,this.camera.updateProjectionMatrix(),this.renderer.setSize(a,b)},clear:function(){this.group&&(this.scene.remove(this.group),this.group=null)},render:function(){this.renderer.render(this.scene,this.camera)},dom:function(){return this.renderer.domElement}});a.module("backends",{ThreeBackend:c})}(),function(){var b=a.module("utils"),c=a.extendClass({init:function(a){this.lon=a[0],this.lat=a[1]},getSphereCoord:function(){return{lon:this.lon,lat:this.lat}},getVectorCoord:function(){var a=this.lon,c=this.lat;c=Math.max(-85,Math.min(85,c));var d=b.degToRad(90-c),e=b.degToRad(a),f=500*Math.sin(d)*Math.cos(e),g=500*Math.cos(d),h=500*Math.sin(d)*Math.sin(e);return{x:f,y:g,z:h}}});a.module("pano",{Position:c})}(),function(){var b=a.extendClass({init:function(a){this.pos=a}}),c=a.extendClass(b,{init:function(a,b,c,d){this.material=a,this.width=b,this.height=c,this.pos=d},getPos:function(){return this.pos}});a.module("pano",{ImageHotspot:c})}(),function(){var b=a.module("pano.Position"),c=a.extendClass({init:function(a,c){this.materials=a,this.pos=c||new b([0,0]),this.hotspots={}},getPos:function(){return this.pos},setPos:function(a){this.pos=a},addHotspot:function(a,b){this.hotspots[a]=b}}),d=a.extendClass(c,{});a.module("pano",{Scene:c,BoxScene:d})}(),function(){var b=a.module("utils"),c=a.module("backends.ThreeBackend"),d=a.module("event.Master"),e=a.module("pano.Position"),f=a.extendClass({init:function(){this.isUserInteracting=!1,this.onMouseDownMouseX=0,this.onMouseDownMouseY=0,this.onPointerDownLon=0,this.onPointerDownLat=0},startMove:function(a,b){this.isUserInteracting=!0,this.onPointerDownPointerX=a.x,this.onPointerDownPointerY=a.y,this.onPointerDownLon=b.lon,this.onPointerDownLat=b.lat},getMovePos:function(a){var b=.1*(this.onPointerDownPointerX-a.x)+this.onPointerDownLon,c=.1*(a.y-this.onPointerDownPointerY)+this.onPointerDownLat;return new e([b,c])},stopMove:function(){this.isUserInteracting=!1}}),g=a.extendClass(b.WidgetObject,{default_options:{width:0,height:0,container:"",draggable:!0,enableScrollWheelZoom:!0,maxZoom:5},init:function(a){this.super("init",[a]),this.container=this.getOption("container"),this.backend=new c(this.getOption("width",this.container.width),this.getOption("height",this.container.height)),this.mevent=new d(this),this.touch_meter=new f,this.scenes={},this._active_scene=null,this._default_scene=null,this._zoom=0,this.bindEvents()},bindEvents:function(){this.container.appendChild(this.backend.dom()),this.container.addEventListener("mousedown",b.proxy(this._onMouseDown,this),!1),this.container.addEventListener("mousemove",b.proxy(this._onMouseMove,this),!1),this.container.addEventListener("mouseup",b.proxy(this._onMouseUp,this),!1),this.container.addEventListener("mousewheel",b.proxy(this._onMouseWheel,this),!1),this.container.addEventListener("touchstart",b.proxy(this._onTouchStart,this),!1),this.container.addEventListener("touchmove",b.proxy(this._onTouchMove,this),!1)},_onMouseDown:function(a){a.preventDefault(),this.touch_meter.startMove(a,this.getActiveScene().getPos())},_onMouseMove:function(a){if(this.touch_meter.isUserInteracting){var b=this.touch_meter.getMovePos(a);this.getOption("draggable")&&this.moveTo(b)}},_onMouseUp:function(){this.touch_meter.stopMove()},_onMouseWheel:function(a){a.preventDefault();var b=a.wheelDeltaY,c=this._zoom+Math.floor(b/120);this.getOption("enableScrollWheelZoom")&&this.setZoom(c)},_onTouchStart:function(a){a.touches&&1==a.touches.length&&(a.preventDefault(),this.touch_meter.startMove({x:a.touches[0].pageX,y:a.touches[0].pageY},this.getActiveScene().getPos()))},_onTouchMove:function(a){if(a.touches&&1==a.touches.length){a.preventDefault();var b=this.touch_meter.getMovePos({x:a.touches[0].pageX,y:a.touches[0].pageY});this.getOption("draggable")&&this.moveTo(b)}},getActiveScene:function(){return this.scenes[this._active_scene]},getScene:function(a){return this.scenes[a]},addScene:function(a,b){this.scenes[a]=b,this._default_scene||(this._default_scene=a)},switchScene:function(a){var b=this.scenes[a];this.backend.setScene(b),this.backend.lookAt(b.getPos().getVectorCoord()),this._active_scene=a},setDefaultScene:function(a){this._default_scene=a},render:function(){var a=this._active_scene||this._default_scene;this.switchScene(a)},bind:function(){this.mevent.bind.apply(this.mevent,arguments)},setZoom:function(a){var b=this.getOption("maxZoom",this.default_options.maxZoom),c=0;a>b&&(a=b),c>a&&(a=c),this.backend.setZoom(a),this._zoom=a},zoomIn:function(){this.setZoom(this._zoom+1)},zoomOut:function(){this.setZoom(this._zoom-1)},moveTo:function(a){this.backend.lookAt(a.getVectorCoord()),this.getActiveScene().setPos(a)},refresh:function(){this.backend.render()}});a.module("pano",{Panorama:g})}(),function(){var b=a.module("pano"),c=a.module("event");a.exports({Event:c.G3Event,pano:{Panorama:b.Panorama,BoxScene:b.BoxScene,ImageHotspot:b.ImageHotspot,Position:b.Position}})}(),d}();