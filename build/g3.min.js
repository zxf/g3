/*!
* g3 v0.0.1
* Copyright 2014 Felix.Zhu
*/
var g3=function(){var a={},b=".",c={};a.module=function(){if(1==arguments.length){if("string"==typeof arguments[0]){var d=[];arguments[0]&&(d=arguments[0].split(b));for(var e=c,f=0;f<d.length;f++){if(!(d[f]in e)){e=void 0;break}e=e[d[f]]}return e}for(var g in arguments[0]){var h=g.split(b),i=h.pop(),j=a.module(h.join(b));j[i]=arguments[0][g]}return c}if("string"==typeof arguments[0]){var e=a.module(arguments[0]);if(void 0!==e)for(var g in arguments[1])e[g]=arguments[1][g];else{var k={};k[arguments[0]]=arguments[1],a.module(k),e=arguments[1]}return e}return void 0},a.Object=function(){},a.Object.prototype={init:function(){}},a.extendClass=function(){var b=a.Object,c={};"string"==typeof arguments[0]?(b=a.module(arguments[0]),c=arguments[1]):"function"==typeof arguments[0]?(b=arguments[0],c=arguments[1]):c=arguments[0];var d=function(){this.parent=e.prototype,this.init.apply(this,arguments)},e=function(){};e.prototype=b.prototype,d.prototype=new e;for(var f in c)d.prototype[f]=c[f];return d};var d={};return a.exports=function(a){for(var b in a)d[b]=a[b]},function(){var b={each:function(a,b){for(var c in a)if(b(a[c],c)===!1)break},map:function(a,b){var c;c=a instanceof Array?[]:{};for(var d in a)c[d]=b(a[d],d);return c},extend:function(){var a=!1,c=0;arguments[0]===!0&&(a=!0,c=1);for(var d=function(c){if(a){if(c instanceof Array)return b.extend(!0,[],c);if(c instanceof Object)return b.extend(!0,{},c)}return c},e=arguments[c],f=c+1;f<arguments.length;f++)if(arguments[f]instanceof Array)for(var g=0;g<arguments[f].length;g++)e[g]=d(arguments[f][g]);else for(var h in arguments[f])e[h]=d(arguments[f][h]);return e},toArray:function(a){return Array.prototype.slice.call(a)},degToRad:function(a){var b=Math.PI/180;return a*b}};a.module("utils",b)}(),function(){var b=a.module("utils"),c=a.extendClass({init:function(a){this._scope=a||window,this._events={}},_bind:function(a,b){a in this._events||(this._events[a]=[]),this._events[a].push(b)},bind:function(){if("string"==typeof arguments[0])this._bind(arguments[0],arguments[1]);else for(var a in arguments[0]){var b=arguments[0][a];this._bind(a,b)}},unbind:function(a,b){if(void 0==b)this._events[a]=null,delete this._events[a];else{var c=(this._events[a]||[]).indexOf(b);c>=0&&this._events[a].splice(c,1)}},trigger:function(){var a=b.toArray(arguments),c=a.shift(),d=this._events[c]||[];for(var e in d)if(d[e].apply(this._scope,a)===!1)return!1;return null},clear:function(){this._events={}}});G3Event=a.extendClass({init:function(a){this._data=a}}),a.module("event",{Master:c,Event:G3Event})}(),function(){var b=a.extendClass({init:function(){}});a.module("backends",{Base:b})}(),function(){var b=a.module("utils"),c=a.extendClass("backends.Base",{init:function(a,b){if(!window.THREE)throw"require three.js.";this.camera=new THREE.PerspectiveCamera(75,a/b,1,1100),this.scene=new THREE.Scene,this.renderer=new THREE.CanvasRenderer,this.renderer.setSize(a,b),this.texture_placeholder=document.createElement("canvas"),this.texture_placeholder.width=128,this.texture_placeholder.height=128},addCubeScene:function(a){var c=this;a=b.map(a,function(a){return c.loadTexture(a)});var d=new THREE.Mesh(new THREE.CubeGeometry(300,300,300,7,7,7),new THREE.MeshFaceMaterial(a)),e=new THREE.Object3D;d.scale.x=-1,this.scene.add(d),this.scene.add(e),this.group=e},loadTexture:function(a){var b=this,c=new THREE.Texture(this.texture_placeholder),d=new THREE.MeshBasicMaterial({map:c,overdraw:!0}),e=new Image;return e.onload=function(){c.needsUpdate=!0,d.map.image=this,b.render()},e.src=a,d},lookAt:function(a){a=new THREE.Vector3(a.x,a.y,a.z),this.camera.lookAt(a)},render:function(){this.renderer.render(this.scene,this.camera)},dom:function(){return this.renderer.domElement}});a.module("backends",{ThreeBackend:c})}(),function(){var b=a.module("utils"),c=a.extendClass({init:function(a){this.lon=a[0],this.lat=a[1]},getLon:function(){return this.lon},getLat:function(){return this.lat},getCoord:function(){var a=this.lon,c=this.lat;c=Math.max(-85,Math.min(85,c));var d=b.degToRad(90-c),e=b.degToRad(a),f=500*Math.sin(d)*Math.cos(e),g=500*Math.cos(d),h=500*Math.sin(d)*Math.sin(e);return{x:f,y:g,z:h}}});a.module("pano",{Position:c})}(),function(){var b=a.extendClass({init:function(a){this.pos=a}});a.module("pano",{Hotspot:b})}(),function(){a.module("pano.Hotspot");var b=a.module("pano.Position"),c=a.extendClass({}),d=a.extendClass(c,{}),e=a.extendClass(c,{init:function(a,c){this.materials=a,this.pos=c||new b([0,0]),this.hotspots={}},setPos:function(a){this.pos=a},getPos:function(){return this.pos},getLon:function(){return this.getPos().getLon()},getLat:function(){return this.getPos().getLat()},getCoord:function(){return this.getPos().getCoord()},addHotspot:function(a,b){this.hotspots[a]=b},getHotspot:function(a){return this.hotspots[a]}});a.module("pano",{StaticScene:d,Scene:e})}(),function(){var b=a.module("utils"),c=a.module("backends.ThreeBackend"),d=a.module("event.Master"),e=(a.module("pano.StaticScene"),a.module("pano.Scene"),a.module("pano.Position")),f=a.extendClass({init:function(a,b,d){this.container=a,this.backend=new c(b,d),this.scene=null,this._draggable=!0,this.bindEvents()},bindEvents:function(){var a=this,b=!1,c=0,d=0,f=0,g=0,h=function(e){a.isDraggable()&&(e.preventDefault(),b=!0,onPointerDownPointerX=e.clientX,onPointerDownPointerY=e.clientY,c=a.scene.getLon(),d=a.scene.getLat())},i=function(h){a.isDraggable()&&b&&(f=.1*(onPointerDownPointerX-h.clientX)+c,g=.1*(h.clientY-onPointerDownPointerY)+d,a.moveTo(new e([f,g])))},j=function(){a.isDraggable()&&(b=!1,a.moveTo(new e([f,g])))},k=function(b){a.isDraggable()&&1==b.touches.length&&(b.preventDefault(),onPointerDownPointerX=b.touches[0].pageX,onPointerDownPointerY=b.touches[0].pageY,c=f,d=g)},l=function(b){a.isDraggable()&&1==b.touches.length&&(b.preventDefault(),f=.1*(onPointerDownPointerX-b.touches[0].pageX)+c,g=.1*(b.touches[0].pageY-onPointerDownPointerY)+d,a.moveTo(new e([f,g])))};this.container.addEventListener("mousedown",h,!1),this.container.addEventListener("mousemove",i,!1),this.container.addEventListener("mouseup",j,!1),this.container.addEventListener("touchstart",k,!1),this.container.addEventListener("touchmove",l,!1)},dom:function(){return this.backend.dom()},draggable:function(a){this._draggable=a},isDraggable:function(){return this._draggable&&this.scene},moveTo:function(a){this.backend.lookAt(a.getCoord()),this.scene.setPos(a),this.backend.render()},render:function(a){this.backend.addCubeScene(a.materials),this.backend.lookAt(a.getCoord()),this.backend.render(),this.scene=a}}),g=a.extendClass({init:function(a){this.opts=b.extend({},a),this.container=this.getOption("container"),this.renderer=new f(this.container,this.getOption("width"),this.getOption("height")),this.draggable(this.getOption("draggable")),this.mevent=new d(this),this.scenes={},this._scene=null,this.bindEvents()},getOption:function(a,b){return a in this.opts?this.opts[a]:b},draggable:function(a){this.renderer.draggable(a),this.opts.draggable=a},bindEvents:function(){this.container.appendChild(this.dom())},addScene:function(a,b){this.scenes[a]=b,this._default||(this._default=a)},switchScene:function(a){this._active=a,this.renderer.render(this.scenes[a])},setDefaultScene:function(a){this._default=a},render:function(){var a=this._active||this._default;this.switchScene(a)},dom:function(){return this.renderer.dom()},bind:function(){this.mevent.bind.apply(this.mevent,arguments)}});a.module("pano",{Render:f,Panorama:g})}(),function(){var b=a.module("pano"),c=a.module("event");a.exports({Event:c.G3Event,pano:{Panorama:b.Panorama,Scene:b.Scene,Hotspot:b.Hotspot,Position:b.Position}})}(),d}();